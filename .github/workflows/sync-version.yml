name: Sync Version from excel2x

on:
  # æ¯å¤© UTC æ—¶é—´ 0:00 æ£€æŸ¥ä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´ 8:00ï¼‰
  schedule:
    - cron: '0 0 * * *'
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # å½“ excel2x æœ‰æ–°çš„ release æ—¶ï¼Œå¯ä»¥é€šè¿‡ repository_dispatch è§¦å‘
  # ä½†è¿™éœ€è¦ excel2x é¡¹ç›®é…ç½®ï¼Œæš‚æ—¶ä½¿ç”¨å®šæ—¶æ£€æŸ¥

jobs:
  check-and-update-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Get current version from pubspec.yaml
        id: current_version
        run: |
          CURRENT_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get latest release from excel2x
        id: excel2x_release
        run: |
          # èŽ·å– excel2x çš„æœ€æ–° release
          RESPONSE=$(curl -s https://api.github.com/repos/RobinYang11/excel2x/releases/latest)
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ release
          if echo "$RESPONSE" | jq -e '.tag_name' > /dev/null 2>&1; then
            LATEST_VERSION=$(echo "$RESPONSE" | jq -r '.tag_name' | sed 's/^v//')
          else
            echo "No releases found, trying tags..."
            # å¦‚æžœ releases ä¸ºç©ºï¼Œå°è¯•èŽ·å–æœ€æ–°çš„ tag
            TAG_RESPONSE=$(curl -s https://api.github.com/repos/RobinYang11/excel2x/tags | jq -r '.[0].name' | sed 's/^v//')
            LATEST_VERSION=$TAG_RESPONSE
          fi
          
          if [ -z "$LATEST_VERSION" ] || [ "$LATEST_VERSION" == "null" ]; then
            echo "Error: Failed to get latest version from excel2x"
            exit 1
          fi
          
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest excel2x version: $LATEST_VERSION"

      - name: Compare versions
        id: version_check
        run: |
          CURRENT="${{ steps.current_version.outputs.current_version }}"
          LATEST="${{ steps.excel2x_release.outputs.latest_version }}"
          
          echo "Current: $CURRENT"
          echo "Latest: $LATEST"
          
          if [ "$CURRENT" != "$LATEST" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "Version mismatch detected. Updating from $CURRENT to $LATEST"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "Versions are in sync. No update needed."
          fi

      - name: Update version in pubspec.yaml
        if: steps.version_check.outputs.needs_update == 'true'
        run: |
          LATEST_VERSION="${{ steps.excel2x_release.outputs.latest_version }}"
          # åœ¨ Linux runner ä¸Šä½¿ç”¨ sed
          sed -i "s/^version: .*/version: $LATEST_VERSION/" pubspec.yaml
          
          echo "Updated version to $LATEST_VERSION"
          cat pubspec.yaml | grep '^version:'

      - name: Download and copy binaries from excel2x
        if: steps.version_check.outputs.needs_update == 'true'
        run: |
          LATEST_VERSION="${{ steps.excel2x_release.outputs.latest_version }}"
          
          echo "Downloading binaries from excel2x v$LATEST_VERSION..."
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"
          
          # ä¸‹è½½æ•´ä¸ªä»“åº“çš„ zip æ–‡ä»¶ï¼ˆåŒ…å« dist ç›®å½•ï¼‰
          echo "Downloading excel2x repository..."
          curl -L -o excel2x.zip "https://github.com/RobinYang11/excel2x/archive/refs/tags/v${LATEST_VERSION}.zip"
          unzip -q excel2x.zip
          
          # æŸ¥æ‰¾ dist ç›®å½•æˆ–æ ¹ç›®å½•ä¸­çš„äºŒè¿›åˆ¶æ–‡ä»¶
          if [ -d "excel2x-${LATEST_VERSION}/dist" ]; then
            DIST_DIR="excel2x-${LATEST_VERSION}/dist"
          elif [ -d "excel2x-${LATEST_VERSION}" ]; then
            DIST_DIR="excel2x-${LATEST_VERSION}"
          else
            echo "Error: Cannot find excel2x directory"
            exit 1
          fi
          
          cd "$DIST_DIR"
          echo "Looking for binaries in: $(pwd)"
          ls -la || true
          
          # åˆ›å»ºé¡¹ç›®çš„ bin ç›®å½•ç»“æž„
          cd ${{ github.workspace }}
          mkdir -p bin/macos/arm64
          mkdir -p bin/macos/intel
          mkdir -p bin/windows
          mkdir -p bin/linux/x64
          mkdir -p bin/linux/arm64
          
          # æ ¹æ® excel2x çš„æ–‡ä»¶å‘½åè§„åˆ™å¤åˆ¶æ–‡ä»¶
          # excel2x çš„æ–‡ä»¶å‘½å: excel2json_macos_intel, excel2json_macos_arm64, excel2json.exe, excel2json_linux
          cd "$TEMP_DIR/$DIST_DIR"
          
          # macOS Intel
          if [ -f "excel2json_macos_intel" ]; then
            cp excel2json_macos_intel ${{ github.workspace }}/bin/macos/intel/excel2json
            chmod +x ${{ github.workspace }}/bin/macos/intel/excel2json
            echo "âœ… Copied excel2json_macos_intel to bin/macos/intel/excel2json"
          fi
          
          # macOS ARM64
          if [ -f "excel2json_macos_arm64" ]; then
            cp excel2json_macos_arm64 ${{ github.workspace }}/bin/macos/arm64/excel2json
            chmod +x ${{ github.workspace }}/bin/macos/arm64/excel2json
            echo "âœ… Copied excel2json_macos_arm64 to bin/macos/arm64/excel2json"
          fi
          
          # Windows
          if [ -f "excel2json.exe" ]; then
            cp excel2json.exe ${{ github.workspace }}/bin/windows/excel2json.exe
            echo "âœ… Copied excel2json.exe to bin/windows/excel2json.exe"
          fi
          
          # Linux (é»˜è®¤ x64ï¼Œå¦‚æžœæœ‰ arm64 ç‰ˆæœ¬éœ€è¦å•ç‹¬å¤„ç†)
          if [ -f "excel2json_linux" ]; then
            cp excel2json_linux ${{ github.workspace }}/bin/linux/x64/excel2json
            chmod +x ${{ github.workspace }}/bin/linux/x64/excel2json
            echo "âœ… Copied excel2json_linux to bin/linux/x64/excel2json"
          fi
          
          # å¦‚æžœ excel2x æœ‰å•ç‹¬çš„ Linux ARM64 ç‰ˆæœ¬
          if [ -f "excel2json_linux_arm64" ] || [ -f "excel2json_linux_aarch64" ]; then
            ARM64_FILE=$(ls excel2json_linux_arm64 excel2json_linux_aarch64 2>/dev/null | head -1)
            if [ -n "$ARM64_FILE" ]; then
              cp "$ARM64_FILE" ${{ github.workspace }}/bin/linux/arm64/excel2json
              chmod +x ${{ github.workspace }}/bin/linux/arm64/excel2json
              echo "âœ… Copied $ARM64_FILE to bin/linux/arm64/excel2json"
            fi
          fi
          
          # éªŒè¯æ–‡ä»¶æ˜¯å¦å¤åˆ¶æˆåŠŸ
          cd ${{ github.workspace }}
          echo ""
          echo "ðŸ“¦ Binary files status:"
          ls -lh bin/macos/arm64/excel2json 2>/dev/null && echo "  âœ… macOS ARM64" || echo "  âŒ macOS ARM64 missing"
          ls -lh bin/macos/intel/excel2json 2>/dev/null && echo "  âœ… macOS Intel" || echo "  âŒ macOS Intel missing"
          ls -lh bin/windows/excel2json.exe 2>/dev/null && echo "  âœ… Windows" || echo "  âŒ Windows missing"
          ls -lh bin/linux/x64/excel2json 2>/dev/null && echo "  âœ… Linux x64" || echo "  âŒ Linux x64 missing"
          ls -lh bin/linux/arm64/excel2json 2>/dev/null && echo "  âœ… Linux ARM64" || echo "  âš ï¸  Linux ARM64 (optional)"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf "$TEMP_DIR"

      - name: Configure Git
        if: steps.version_check.outputs.needs_update == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update CHANGELOG.md
        if: steps.version_check.outputs.needs_update == 'true'
        run: |
          LATEST_VERSION="${{ steps.excel2x_release.outputs.latest_version }}"
          
          # æ£€æŸ¥ CHANGELOG.md æ˜¯å¦å·²åŒ…å«å½“å‰ç‰ˆæœ¬
          if ! grep -q "## $LATEST_VERSION" CHANGELOG.md; then
            echo "Updating CHANGELOG.md with version $LATEST_VERSION..."
            # åœ¨æ–‡ä»¶å¼€å¤´æ’å…¥æ–°ç‰ˆæœ¬æ¡ç›®
            cat > /tmp/changelog_entry.txt << EOF
## $LATEST_VERSION

* è‡ªåŠ¨åŒæ­¥ excel2x ç‰ˆæœ¬åˆ° $LATEST_VERSION
* æ›´æ–°äºŒè¿›åˆ¶æ–‡ä»¶åˆ° v$LATEST_VERSION ç‰ˆæœ¬

EOF
            # å°†æ–°æ¡ç›®æ’å…¥åˆ°æ–‡ä»¶å¼€å¤´ï¼ˆåœ¨ç¬¬ä¸€ä¸ªç‰ˆæœ¬ä¹‹å‰ï¼‰
            sed -i "1r /tmp/changelog_entry.txt" CHANGELOG.md
            echo "âœ… CHANGELOG.md updated"
          else
            echo "â„¹ï¸ CHANGELOG.md already contains version $LATEST_VERSION"
          fi

      - name: Commit and tag version update
        if: steps.version_check.outputs.needs_update == 'true'
        run: |
          LATEST_VERSION="${{ steps.excel2x_release.outputs.latest_version }}"
          git add pubspec.yaml
          git add bin/
          git add CHANGELOG.md
          git commit -m "chore: sync version to $LATEST_VERSION and update binaries from excel2x"
          git tag -a "v$LATEST_VERSION" -m "Version $LATEST_VERSION - synced with excel2x"
          git push origin main
          git push origin "v$LATEST_VERSION"
          
          echo "âœ… Version and binaries updated and pushed. Build will be triggered automatically."

      - name: Summary
        run: |
          if [ "${{ steps.version_check.outputs.needs_update }}" == "true" ]; then
            echo "âœ… Version updated successfully!"
            echo "Updated from ${{ steps.current_version.outputs.current_version }} to ${{ steps.excel2x_release.outputs.latest_version }}"
          else
            echo "â„¹ï¸ No version update needed. Current version is up to date."
          fi

