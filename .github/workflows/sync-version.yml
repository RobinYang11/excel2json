name: Sync Version from excel2x

on:
  # ÊØèÂ§© UTC Êó∂Èó¥ 0:00 Ê£ÄÊü•‰∏ÄÊ¨°ÔºàÂåó‰∫¨Êó∂Èó¥ 8:00Ôºâ
  schedule:
    - cron: '0 0 * * *'
  # ÊîØÊåÅÊâãÂä®Ëß¶Âèë
  workflow_dispatch:
  # ÂΩì excel2x ÊúâÊñ∞ÁöÑ release Êó∂ÔºåÂèØ‰ª•ÈÄöËøá repository_dispatch Ëß¶Âèë
  # ‰ΩÜËøôÈúÄË¶Å excel2x È°πÁõÆÈÖçÁΩÆÔºåÊöÇÊó∂‰ΩøÁî®ÂÆöÊó∂Ê£ÄÊü•

jobs:
  check-and-update-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Get current version from pubspec.yaml
        id: current_version
        run: |
          CURRENT_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | tr -d ' ')
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get latest release from excel2x
        id: excel2x_release
        run: |
          # Ëé∑Âèñ excel2x ÁöÑÊúÄÊñ∞ release
          RESPONSE=$(curl -s https://api.github.com/repos/RobinYang11/excel2x/releases/latest)
          
          # Ê£ÄÊü•ÊòØÂê¶Êúâ release
          if echo "$RESPONSE" | jq -e '.tag_name' > /dev/null 2>&1; then
            LATEST_VERSION=$(echo "$RESPONSE" | jq -r '.tag_name' | sed 's/^v//')
          else
            echo "No releases found, trying tags..."
            # Â¶ÇÊûú releases ‰∏∫Á©∫ÔºåÂ∞ùËØïËé∑ÂèñÊúÄÊñ∞ÁöÑ tag
            TAG_RESPONSE=$(curl -s https://api.github.com/repos/RobinYang11/excel2x/tags | jq -r '.[0].name' | sed 's/^v//')
            LATEST_VERSION=$TAG_RESPONSE
          fi
          
          if [ -z "$LATEST_VERSION" ] || [ "$LATEST_VERSION" == "null" ]; then
            echo "Error: Failed to get latest version from excel2x"
            exit 1
          fi
          
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Latest excel2x version: $LATEST_VERSION"

      - name: Compare versions
        id: version_check
        run: |
          CURRENT="${{ steps.current_version.outputs.current_version }}"
          LATEST="${{ steps.excel2x_release.outputs.latest_version }}"
          
          echo "Current: $CURRENT"
          echo "Latest: $LATEST"
          
          if [ "$CURRENT" != "$LATEST" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "Version mismatch detected. Updating from $CURRENT to $LATEST"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "Versions are in sync. No update needed."
          fi

      - name: Update version in pubspec.yaml
        if: steps.version_check.outputs.needs_update == 'true'
        run: |
          LATEST_VERSION="${{ steps.excel2x_release.outputs.latest_version }}"
          # Âú® Linux runner ‰∏ä‰ΩøÁî® sed
          sed -i "s/^version: .*/version: $LATEST_VERSION/" pubspec.yaml
          
          echo "Updated version to $LATEST_VERSION"
          cat pubspec.yaml | grep '^version:'

      - name: Download and copy binaries from excel2x
        if: steps.version_check.outputs.needs_update == 'true'
        run: |
          LATEST_VERSION="${{ steps.excel2x_release.outputs.latest_version }}"
          
          echo "Downloading binaries from excel2x v$LATEST_VERSION..."
          
          # ÂàõÂª∫‰∏¥Êó∂ÁõÆÂΩï
          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"
          
          # ‰∏ãËΩΩÊï¥‰∏™‰ªìÂ∫ìÁöÑ zip Êñá‰ª∂ÔºàÂåÖÂê´ dist ÁõÆÂΩïÔºâ
          echo "Downloading excel2x repository..."
          curl -L -o excel2x.zip "https://github.com/RobinYang11/excel2x/archive/refs/tags/v${LATEST_VERSION}.zip"
          unzip -q excel2x.zip
          
          # Êü•Êâæ dist ÁõÆÂΩïÊàñÊ†πÁõÆÂΩï‰∏≠ÁöÑ‰∫åËøõÂà∂Êñá‰ª∂
          if [ -d "excel2x-${LATEST_VERSION}/dist" ]; then
            DIST_DIR="excel2x-${LATEST_VERSION}/dist"
          elif [ -d "excel2x-${LATEST_VERSION}" ]; then
            DIST_DIR="excel2x-${LATEST_VERSION}"
          else
            echo "Error: Cannot find excel2x directory"
            exit 1
          fi
          
          cd "$DIST_DIR"
          echo "Looking for binaries in: $(pwd)"
          ls -la || true
          
          # ÂàõÂª∫È°πÁõÆÁöÑ bin ÁõÆÂΩïÁªìÊûÑ
          cd ${{ github.workspace }}
          mkdir -p bin/macos/arm64
          mkdir -p bin/macos/intel
          mkdir -p bin/windows
          mkdir -p bin/linux/x64
          mkdir -p bin/linux/arm64
          
          # Ê†πÊçÆ excel2x ÁöÑÊñá‰ª∂ÂëΩÂêçËßÑÂàôÂ§çÂà∂Êñá‰ª∂
          # excel2x ÁöÑÊñá‰ª∂ÂëΩÂêç: excel2json_macos_intel, excel2json_macos_arm64, excel2json.exe, excel2json_linux
          cd "$TEMP_DIR/$DIST_DIR"
          
          # macOS Intel
          if [ -f "excel2json_macos_intel" ]; then
            cp excel2json_macos_intel ${{ github.workspace }}/bin/macos/intel/excel2json
            chmod +x ${{ github.workspace }}/bin/macos/intel/excel2json
            echo "‚úÖ Copied excel2json_macos_intel to bin/macos/intel/excel2json"
          fi
          
          # macOS ARM64
          if [ -f "excel2json_macos_arm64" ]; then
            cp excel2json_macos_arm64 ${{ github.workspace }}/bin/macos/arm64/excel2json
            chmod +x ${{ github.workspace }}/bin/macos/arm64/excel2json
            echo "‚úÖ Copied excel2json_macos_arm64 to bin/macos/arm64/excel2json"
          fi
          
          # Windows
          if [ -f "excel2json.exe" ]; then
            cp excel2json.exe ${{ github.workspace }}/bin/windows/excel2json.exe
            echo "‚úÖ Copied excel2json.exe to bin/windows/excel2json.exe"
          fi
          
          # Linux (ÈªòËÆ§ x64ÔºåÂ¶ÇÊûúÊúâ arm64 ÁâàÊú¨ÈúÄË¶ÅÂçïÁã¨Â§ÑÁêÜ)
          if [ -f "excel2json_linux" ]; then
            cp excel2json_linux ${{ github.workspace }}/bin/linux/x64/excel2json
            chmod +x ${{ github.workspace }}/bin/linux/x64/excel2json
            echo "‚úÖ Copied excel2json_linux to bin/linux/x64/excel2json"
          fi
          
          # Â¶ÇÊûú excel2x ÊúâÂçïÁã¨ÁöÑ Linux ARM64 ÁâàÊú¨
          if [ -f "excel2json_linux_arm64" ] || [ -f "excel2json_linux_aarch64" ]; then
            ARM64_FILE=$(ls excel2json_linux_arm64 excel2json_linux_aarch64 2>/dev/null | head -1)
            if [ -n "$ARM64_FILE" ]; then
              cp "$ARM64_FILE" ${{ github.workspace }}/bin/linux/arm64/excel2json
              chmod +x ${{ github.workspace }}/bin/linux/arm64/excel2json
              echo "‚úÖ Copied $ARM64_FILE to bin/linux/arm64/excel2json"
            fi
          fi
          
          # È™åËØÅÊñá‰ª∂ÊòØÂê¶Â§çÂà∂ÊàêÂäü
          cd ${{ github.workspace }}
          echo ""
          echo "üì¶ Binary files status:"
          ls -lh bin/macos/arm64/excel2json 2>/dev/null && echo "  ‚úÖ macOS ARM64" || echo "  ‚ùå macOS ARM64 missing"
          ls -lh bin/macos/intel/excel2json 2>/dev/null && echo "  ‚úÖ macOS Intel" || echo "  ‚ùå macOS Intel missing"
          ls -lh bin/windows/excel2json.exe 2>/dev/null && echo "  ‚úÖ Windows" || echo "  ‚ùå Windows missing"
          ls -lh bin/linux/x64/excel2json 2>/dev/null && echo "  ‚úÖ Linux x64" || echo "  ‚ùå Linux x64 missing"
          ls -lh bin/linux/arm64/excel2json 2>/dev/null && echo "  ‚úÖ Linux ARM64" || echo "  ‚ö†Ô∏è  Linux ARM64 (optional)"
          
          # Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂
          rm -rf "$TEMP_DIR"

      - name: Configure Git
        if: steps.version_check.outputs.needs_update == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and tag version update
        if: steps.version_check.outputs.needs_update == 'true'
        run: |
          LATEST_VERSION="${{ steps.excel2x_release.outputs.latest_version }}"
          git add pubspec.yaml
          git add bin/
          git commit -m "chore: sync version to $LATEST_VERSION and update binaries from excel2x"
          git tag -a "v$LATEST_VERSION" -m "Version $LATEST_VERSION - synced with excel2x"
          git push origin main
          git push origin "v$LATEST_VERSION"
          
          echo "‚úÖ Version and binaries updated and pushed. Build will be triggered automatically."

      - name: Summary
        run: |
          if [ "${{ steps.version_check.outputs.needs_update }}" == "true" ]; then
            echo "‚úÖ Version updated successfully!"
            echo "Updated from ${{ steps.current_version.outputs.current_version }} to ${{ steps.excel2x_release.outputs.latest_version }}"
          else
            echo "‚ÑπÔ∏è No version update needed. Current version is up to date."
          fi

